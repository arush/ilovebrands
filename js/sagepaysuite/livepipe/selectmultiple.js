if(typeof(Prototype)=="undefined"){throw"Control.SelectMultiple requires Prototype to be loaded."}if(typeof(Object.Event)=="undefined"){throw"Control.SelectMultiple requires Object.Event to be loaded."}Control.SelectMultiple=Class.create({select:false,container:false,numberOfCheckedBoxes:0,checkboxes:[],hasExtraOption:false,initialize:function(b,c,d){this.options={checkboxSelector:"input[type=checkbox]",nameSelector:"span.name",labelSeparator:", ",valueSeparator:",",afterChange:Prototype.emptyFunction,overflowString:function(e){return e.truncate()},overflowLength:30};Object.extend(this.options,d||{});this.select=$(b);this.container=$(c);this.checkboxes=(typeof(this.options.checkboxSelector)=="function")?this.options.checkboxSelector.bind(this)():this.container.getElementsBySelector(this.options.checkboxSelector);var a=false;if(this.options.value){a=true;this.setValue(this.options.value);delete this.options.value}this.hasExtraOption=false;this.checkboxes.each(function(e){e.observe("click",this.checkboxOnClick.bind(this,e))}.bind(this));this.select.observe("change",this.selectOnChange.bind(this));this.countAndCheckCheckBoxes();if(!a){this.scanCheckBoxes()}this.notify("afterChange",this.select.options[this.select.options.selectedIndex].value)},countAndCheckCheckBoxes:function(){this.numberOfCheckedBoxes=this.checkboxes.inject(0,function(c,d){d.checked=(this.select.options[this.select.options.selectedIndex].value==d.value);var b=this.select.options[this.select.options.selectedIndex].value;var e=$A(b.split?b.split(this.options.valueSeparator):b);var a=e.any(function(f){if(!a&&d.value==f){return true}}.bind(this));d.checked=a;if(d.checked){++c}return c}.bind(this))},setValue:function(a){this.numberOfCheckedBoxes=0;var b=$A(a.split?a.split(this.options.valueSeparator):a);this.checkboxes.each(function(c){c.checked=false;b.each(function(d){if(c.value==d){++this.numberOfCheckedBoxes;c.checked=true}}.bind(this))}.bind(this));this.scanCheckBoxes()},selectOnChange:function(){this.removeExtraOption();this.countAndCheckCheckBoxes();this.notify("afterChange",this.select.options[this.select.options.selectedIndex].value)},checkboxOnClick:function(a){this.numberOfCheckedBoxes=this.checkboxes.findAll(function(b){return b.checked}).length;this.scanCheckBoxes();this.notify("afterChange",this.numberOfCheckedBoxes===0?"":this.select.options[this.select.options.selectedIndex].value)},scanCheckBoxes:function(){switch(this.numberOfCheckedBoxes){case 1:this.checkboxes.each(function(a){if(a.checked){$A(this.select.options).each(function(c,b){if(c.value==a.value){this.select.options.selectedIndex=b;throw $break}}.bind(this));throw $break}}.bind(this));break;case 0:this.removeExtraOption();break;default:this.addExtraOption();break}},getLabelForExtraOption:function(){var a=(typeof(this.options.nameSelector)=="function"?this.options.nameSelector.bind(this)():this.container.getElementsBySelector(this.options.nameSelector).inject([],function(d,c,b){if(this.checkboxes[b].checked){d.push(c.innerHTML)}return d}.bind(this))).join(this.options.labelSeparator);return(a.length>=this.options.overflowLength&&this.options.overflowLength>0)?(typeof(this.options.overflowString)=="function"?this.options.overflowString(a):this.options.overflowString):a},getValueForExtraOption:function(){return this.checkboxes.inject([],function(a,b){if(b.checked){a.push(b.value)}return a}).join(this.options.valueSeparator)},addExtraOption:function(){this.removeExtraOption();this.hasExtraOption=true;this.select.options[this.select.options.length]=new Option(this.getLabelForExtraOption(),this.getValueForExtraOption());this.select.options.selectedIndex=this.select.options.length-1},removeExtraOption:function(){if(this.hasExtraOption){this.select.remove(this.select.options.length-1);this.hasExtraOption=false}}});Object.Event.extend(Control.SelectMultiple);