if(typeof(Prototype)=="undefined"){throw"Control.Selection requires Prototype to be loaded."}if(typeof(Object.Event)=="undefined"){throw"Control.Selection requires Object.Event to be loaded."}Control.Selection={options:{resize_layout_timeout:125,selected:Prototype.emptyFunction,deselected:Prototype.emptyFunction,change:Prototype.emptyFunction,selection_id:"control_selection",selection_style:{zIndex:999,cursor:"default",border:"1px dotted #000"},filter:function(a){return true},drag_proxy:false,drag_proxy_threshold:1,drag_proxy_options:{}},selectableElements:[],elements:[],selectableObjects:[],objects:[],active:false,container:false,resizeTimeout:false,load:function(b){Control.Selection.options=Object.extend(Control.Selection.options,b||{});Control.Selection.selection_div=$(document.createElement("div"));Control.Selection.selection_div.id=Control.Selection.options.selection_id;Control.Selection.selection_div.style.display="none";Control.Selection.selection_div.setStyle(Control.Selection.options.selection_style);Control.Selection.border_width=parseInt(Control.Selection.selection_div.getStyle("border-top-width"),10)*2;Control.Selection.container=Prototype.Browser.IE?window.container:window;$(document.body).insert(Control.Selection.selection_div);Control.Selection.enable();if(Control.Selection.options.drag_proxy&&typeof(Draggable)!="undefined"){Control.Selection.DragProxy.load()}Event.observe(window,"resize",function(){if(Control.Selection.resizeTimeout){window.clearTimeout(Control.Selection.resizeTimeout)}Control.Selection.resizeTimeout=window.setTimeout(Control.Selection.recalculateLayout,Control.Selection.options.resize_layout_timeout)});if(Prototype.Browser.IE){var a=$$("body").first();a.observe("mouseleave",Control.Selection.stop);a.observe("mouseup",Control.Selection.stop)}},enable:function(){if(Prototype.Browser.IE){document.onselectstart=function(){return false}}Event.observe(Control.Selection.container,"mousedown",Control.Selection.start);Event.observe(Control.Selection.container,"mouseup",Control.Selection.stop)},disable:function(){if(Prototype.Browser.IE){document.onselectstart=function(){return true}}Event.stopObserving(Control.Selection.container,"mousedown",Control.Selection.start);Event.stopObserving(Control.Selection.container,"mouseup",Control.Selection.stop)},recalculateLayout:function(){Control.Selection.selectableElements.each(function(b){var c=b.getDimensions();var d=b.cumulativeOffset();var a=b.cumulativeScrollOffset();if(!b._control_selection){b._control_selection={}}b._control_selection.top=d[1]-a[1];b._control_selection.left=d[0]-a[0];b._control_selection.width=c.width;b._control_selection.height=c.height})},addSelectable:function(b,a,d,e){b=$(b);if(d){d=d.each?d:[d]}var c=b.getDimensions();var f=Element.cumulativeOffset(b);b._control_selection={activation_targets:d,is_selected:false,top:f[1],left:f[0],width:c.width,height:c.height,activationTargetMouseMove:function(){Control.Selection.notify("activationTargetMouseMove",b);if(d){d.each(function(g){g.stopObserving("mousemove",b._control_selection.activationTargetMouseMove)})}Control.Selection.DragProxy.container.stopObserving("mousemove",b._control_selection.activationTargetMouseMove)},activationTargetMouseDown:function(g){if(!Control.Selection.elements.include(b)){Control.Selection.select(b)}Control.Selection.DragProxy.start(g);Control.Selection.DragProxy.container.hide();if(d){d.each(function(h){h.observe("mousemove",b._control_selection.activationTargetMouseMove)})}Control.Selection.DragProxy.container.observe("mousemove",b._control_selection.activationTargetMouseMove)},activationTargetClick:function(){Control.Selection.select(b);if(typeof(e)=="function"){e()}if(d){d.each(function(g){g.stopObserving("mousemove",b._control_selection.activationTargetMouseMove)})}Control.Selection.DragProxy.container.stopObserving("mousemove",b._control_selection.activationTargetMouseMove)}};b.onselectstart=function(){return false};b.unselectable="on";b.style.MozUserSelect="none";if(d){d.each(function(g){g.observe("mousedown",b._control_selection.activationTargetMouseDown);g.observe("click",b._control_selection.activationTargetClick)})}Control.Selection.selectableElements.push(b);Control.Selection.selectableObjects.push(a)},removeSelectable:function(b){b=$(b);if(b._control_selection.activation_targets){b._control_selection.activation_targets.each(function(c){c.stopObserving("mousedown",b._control_selection.activationTargetMouseDown)});b._control_selection.activation_targets.each(function(c){c.stopObserving("click",b._control_selection.activationTargetClick)})}b._control_selection=null;b.onselectstart=function(){return true};b.unselectable="off";b.style.MozUserSelect="";var a=0;Control.Selection.selectableElements.each(function(c,d){if(c==b){a=d;throw $break}});Control.Selection.selectableElements=Control.Selection.selectableElements.without(b);Control.Selection.selectableObjects=Control.Selection.selectableObjects.slice(0,a).concat(Control.Selection.selectableObjects.slice(a+1))},select:function(c){if(typeof(c)=="undefined"||!c){c=[]}if(!c.each&&!c._each){c=[c]}var a=!(Control.Selection.elements.length==c.length&&Control.Selection.elements.all(function(f,e){return c[e]==f}));if(!a){return}var b={};var d=c.collect(function(e){var f=Control.Selection.selectableObjects[Control.Selection.selectableElements.indexOf(e)];b[e]=f;return f});if(Control.Selection.elements.length===0&&c.length!==0){c.each(function(e){Control.Selection.notify("selected",e,b[e])})}else{Control.Selection.elements.each(function(e){if(!c.include(e)){Control.Selection.notify("deselected",e,b[e])}});c.each(function(e){if(!Control.Selection.elements.include(e)){Control.Selection.notify("selected",e,b[e])}})}Control.Selection.elements=c;Control.Selection.objects=d;Control.Selection.notify("change",Control.Selection.elements,Control.Selection.objects)},deselect:function(){if(Control.Selection.notify("deselect")===false){return false}Control.Selection.elements.each(function(a){Control.Selection.notify("deselected",a,Control.Selection.selectableObjects[Control.Selection.selectableElements.indexOf(a)])});Control.Selection.objects=[];Control.Selection.elements=[];Control.Selection.notify("change",Control.Selection.objects,Control.Selection.elements);return true},start:function(a){if(!a.isLeftClick()||Control.Selection.notify("start",a)===false){return false}if(!a.shiftKey&&!a.altKey){Control.Selection.deselect()}Event.observe(Control.Selection.container,"mousemove",Control.Selection.onMouseMove);Event.stop(a);return false},stop:function(){Event.stopObserving(Control.Selection.container,"mousemove",Control.Selection.onMouseMove);Control.Selection.active=false;Control.Selection.selection_div.setStyle({display:"none",top:null,left:null,width:null,height:null});Control.Selection.start_mouse_coordinates={};Control.Selection.current_mouse_coordinates={}},mouseCoordinatesFromEvent:function(a){return{x:Event.pointerX(a),y:Event.pointerY(a)}},onClick:function(c,a,d){var b=[];if(c.shiftKey){b=Control.Selection.elements.clone();if(!b.include(a)){b.push(a)}}else{if(c.altKey){b=Control.Selection.elements.clone();if(b.include(a)){b=b.without(a)}}else{b=[a]}}Control.Selection.select(b);if(d=="click"){Event.stop(c)}},onMouseMove:function(b){if(!Control.Selection.active){Control.Selection.active=true;Control.Selection.start_mouse_coordinates=Control.Selection.mouseCoordinatesFromEvent(b)}else{Control.Selection.current_mouse_coordinates=Control.Selection.mouseCoordinatesFromEvent(b);Control.Selection.drawSelectionDiv();var a=Control.Selection.selectableElements.findAll(function(c){return Control.Selection.options.filter(c)&&Control.Selection.elementWithinSelection(c)});if(b.shiftKey&&!b.altKey){Control.Selection.elements.each(function(c){if(!a.include(c)){a.push(c)}})}else{if(b.altKey&&!b.shiftKey){a=Control.Selection.elements.findAll(function(c){return !a.include(c)})}}Control.Selection.select(a)}},drawSelectionDiv:function(){if(Control.Selection.start_mouse_coordinates==Control.Selection.current_mouse_coordinates){Control.Selection.selection_div.style.display="none"}else{Control.Selection.viewport=document.viewport.getDimensions();Control.Selection.selection_div.style.position="absolute";Control.Selection.current_direction=(Control.Selection.start_mouse_coordinates.y>Control.Selection.current_mouse_coordinates.y?"N":"S")+(Control.Selection.start_mouse_coordinates.x<Control.Selection.current_mouse_coordinates.x?"E":"W");Control.Selection.selection_div.setStyle(Control.Selection["dimensionsFor"+Control.Selection.current_direction]());Control.Selection.selection_div.style.display="block"}},dimensionsForNW:function(){return{top:(Control.Selection.start_mouse_coordinates.y-(Control.Selection.start_mouse_coordinates.y-Control.Selection.current_mouse_coordinates.y))+"px",left:(Control.Selection.start_mouse_coordinates.x-(Control.Selection.start_mouse_coordinates.x-Control.Selection.current_mouse_coordinates.x))+"px",width:(Control.Selection.start_mouse_coordinates.x-Control.Selection.current_mouse_coordinates.x)+"px",height:(Control.Selection.start_mouse_coordinates.y-Control.Selection.current_mouse_coordinates.y)+"px"}},dimensionsForNE:function(){return{top:(Control.Selection.start_mouse_coordinates.y-(Control.Selection.start_mouse_coordinates.y-Control.Selection.current_mouse_coordinates.y))+"px",left:Control.Selection.start_mouse_coordinates.x+"px",width:Math.min((Control.Selection.viewport.width-Control.Selection.start_mouse_coordinates.x)-Control.Selection.border_width,Control.Selection.current_mouse_coordinates.x-Control.Selection.start_mouse_coordinates.x)+"px",height:(Control.Selection.start_mouse_coordinates.y-Control.Selection.current_mouse_coordinates.y)+"px"}},dimensionsForSE:function(){return{top:Control.Selection.start_mouse_coordinates.y+"px",left:Control.Selection.start_mouse_coordinates.x+"px",width:Math.min((Control.Selection.viewport.width-Control.Selection.start_mouse_coordinates.x)-Control.Selection.border_width,Control.Selection.current_mouse_coordinates.x-Control.Selection.start_mouse_coordinates.x)+"px",height:Math.min((Control.Selection.viewport.height-Control.Selection.start_mouse_coordinates.y)-Control.Selection.border_width,Control.Selection.current_mouse_coordinates.y-Control.Selection.start_mouse_coordinates.y)+"px"}},dimensionsForSW:function(){return{top:Control.Selection.start_mouse_coordinates.y+"px",left:(Control.Selection.start_mouse_coordinates.x-(Control.Selection.start_mouse_coordinates.x-Control.Selection.current_mouse_coordinates.x))+"px",width:(Control.Selection.start_mouse_coordinates.x-Control.Selection.current_mouse_coordinates.x)+"px",height:Math.min((Control.Selection.viewport.height-Control.Selection.start_mouse_coordinates.y)-Control.Selection.border_width,Control.Selection.current_mouse_coordinates.y-Control.Selection.start_mouse_coordinates.y)+"px"}},inBoundsForNW:function(a,b){return(((a.left>b.left||a.right>b.left)&&b.right>a.left)&&((a.top>b.top||a.bottom>b.top)&&b.bottom>a.top))},inBoundsForNE:function(a,b){return(((a.left<b.right||a.left<b.right)&&b.left<a.right)&&((a.top>b.top||a.bottom>b.top)&&b.bottom>a.top))},inBoundsForSE:function(a,b){return(((a.left<b.right||a.left<b.right)&&b.left<a.right)&&((a.bottom<b.bottom||a.top<b.bottom)&&b.top<a.bottom))},inBoundsForSW:function(a,b){return(((a.left>b.left||a.right>b.left)&&b.right>a.left)&&((a.bottom<b.bottom||a.top<b.bottom)&&b.top<a.bottom))},elementWithinSelection:function(a){if(Control.Selection["inBoundsFor"+Control.Selection.current_direction]({top:a._control_selection.top,left:a._control_selection.left,bottom:a._control_selection.top+a._control_selection.height,right:a._control_selection.left+a._control_selection.width},{top:parseInt(Control.Selection.selection_div.style.top,10),left:parseInt(Control.Selection.selection_div.style.left,10),bottom:parseInt(Control.Selection.selection_div.style.top,10)+parseInt(Control.Selection.selection_div.style.height,10),right:parseInt(Control.Selection.selection_div.style.left,10)+parseInt(Control.Selection.selection_div.style.width,10)})){a._control_selection.is_selected=true;return true}else{a._control_selection.is_selected=false;return false}},DragProxy:{active:false,xorigin:0,yorigin:0,load:function(){Control.Selection.DragProxy.container=$(document.createElement("div"));Control.Selection.DragProxy.container.id="control_selection_drag_proxy";Control.Selection.DragProxy.container.setStyle({position:"absolute",top:"1px",left:"1px",zIndex:99999});Control.Selection.DragProxy.container.hide();document.body.appendChild(Control.Selection.DragProxy.container);Control.Selection.observe("selected",Control.Selection.DragProxy.selected);Control.Selection.observe("deselected",Control.Selection.DragProxy.deselected)},start:function(a){if(a.isRightClick()){Control.Selection.DragProxy.container.hide();return}if(Control.Selection.DragProxy.xorigin==Event.pointerX(a)&&Control.Selection.DragProxy.yorigin==Event.pointerY(a)){return}Control.Selection.DragProxy.active=true;Control.Selection.DragProxy.container.setStyle({position:"absolute",top:Event.pointerY(a)+"px",left:Event.pointerX(a)+"px"});Control.Selection.DragProxy.container.observe("mouseup",Control.Selection.DragProxy.onMouseUp);Control.Selection.DragProxy.container.show();Control.Selection.DragProxy.container._draggable=new Draggable(Control.Selection.DragProxy.container,Object.extend({onEnd:Control.Selection.DragProxy.stop},Control.Selection.options.drag_proxy_options));Control.Selection.DragProxy.container._draggable.eventMouseDown(a);Control.Selection.DragProxy.notify("start",Control.Selection.DragProxy.container,Control.Selection.elements)},stop:function(){window.setTimeout(function(){Control.Selection.DragProxy.active=false;Control.Selection.DragProxy.container.hide();if(Control.Selection.DragProxy.container._draggable){Control.Selection.DragProxy.container._draggable.destroy();Control.Selection.DragProxy.container._draggable=null}Control.Selection.DragProxy.notify("stop")},1)},onClick:function(a){Control.Selection.DragProxy.xorigin=Event.pointerX(a);Control.Selection.DragProxy.yorigin=Event.pointerY(a);if(a.isRightClick()){Control.Selection.DragProxy.container.hide()}if(Control.Selection.elements.length>=Control.Selection.options.drag_proxy_threshold&&!(a.shiftKey||a.altKey)&&(Control.Selection.DragProxy.xorigin!=Event.pointerX(a)||Control.Selection.DragProxy.yorigin!=Event.pointerY(a))){Control.Selection.DragProxy.start(a);Event.stop(a)}},onMouseUp:function(a){Control.Selection.DragProxy.stop();Control.Selection.DragProxy.container.stopObserving("mouseup",Control.Selection.DragProxy.onMouseUp)},selected:function(a){a.observe("mousedown",Control.Selection.DragProxy.onClick)},deselected:function(a){a.stopObserving("mousedown",Control.Selection.DragProxy.onClick)}}};Object.Event.extend(Control.Selection);Object.Event.extend(Control.Selection.DragProxy);